# See https://fly.io/docs/app-guides/continuous-deployment-with-github-actions/

name: Fly Deploy
on:
  push:
    branches:
      - main
env:
  FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}
  FLY_APP_NAME:  ocean-staging     # deploy to staging environment
  npm_config_onnxruntime_gpu: "false"  # Force CPU variant of ONNX runtime

jobs:
  deploy:
    name: Deploy app
    runs-on: ubuntu-latest
    concurrency: deploy-group    # optional: ensure only one action runs at a time
    steps:
      - uses: actions/checkout@v4
      
      # Add pnpm setup and install dependencies if needed
      - uses: pnpm/action-setup@v2
        with:
          version: 9
      
      - name: Install dependencies if needed
        run: |
          if [ -f "pnpm-lock.yaml" ]; then
            pnpm install --frozen-lockfile
            
            # Block onnxruntime postinstall script AFTER installation
            npm pkg set scripts.postinstall="echo skipped" \
              --workspace packages/server/node_modules/onnxruntime-node
            
            # Manually download and extract ONNX Runtime CPU binary
            curl -L https://aiinfra.pkgs.visualstudio.com/PublicPackages/_packaging/onnxruntime/nuget/v3/flatcontainer/microsoft.ml.onnxruntime.linux-x64/1.22.0/microsoft.ml.onnxruntime.linux-x64.1.22.0.nupkg -o ort.nupkg
            unzip -q ort.nupkg -d ort-extract
            mkdir -p node_modules/onnxruntime-node/bin
            cp ort-extract/runtimes/linux-x64/native/libonnxruntime.so node_modules/onnxruntime-node/bin/
          fi
      
      - uses: superfly/flyctl-actions/setup-flyctl@master
      - name: Deploy app
        run: flyctl deploy --remote-only --app $FLY_APP_NAME
        env:
          FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}
      - name: Run seed script
        run: flyctl ssh console -C "pnpm ts-node scripts/seedAll.ts"
        env:
          FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}
