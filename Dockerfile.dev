FROM node:20
WORKDIR /app
COPY . .
RUN corepack enable && pnpm install

# Install node-cron globally to ensure it's available
RUN npm install -g node-cron
RUN pnpm add -w node-cron
RUN pnpm add -F server node-cron
RUN pnpm add -F server @types/node-cron -D

# Build the frontend UI
RUN pnpm --filter ui build

# Install a static server for UI
RUN pnpm add -w serve

# Start backend and serve frontend
CMD ["bash", "-c", "pnpm --filter server run dev & serve packages/ui/dist --single -l 5173"] 